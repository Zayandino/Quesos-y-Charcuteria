<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - CABRA & CURADO</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="styles.css">

    <style>
        /* Estilos espec√≠ficos para Checkout */
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            padding-top: 80px;
            /* Header fixed */
        }

        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 4rem;
        }

        .checkout-section {
            margin-bottom: 3rem;
        }

        .checkout-title {
            font-family: var(--font-heading);
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--gold);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .form-full {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            letter-spacing: 0.05em;
        }

        .form-control {
            width: 100%;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            font-family: var(--font-body);
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--gold);
            background: #2a2a2a;
        }

        /* Order Summary (Sticky) */
        .order-summary {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: var(--radius);
            position: sticky;
            top: 100px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-muted);
        }

        .summary-total {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.5rem;
            color: var(--gold);
            font-family: var(--font-heading);
            font-weight: 700;
        }

        .checkout-items {
            margin-bottom: 2rem;
            max-height: 300px;
            overflow-y: auto;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1rem;
        }

        .checkout-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .item-image {
            width: 60px;
            height: 60px;
            background: var(--bg-sec);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .item-details h4 {
            font-size: 1rem;
            margin-bottom: 0.2rem;
            color: var(--text-main);
        }

        .item-details p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .payment-methods {
            margin-top: 2rem;
        }

        .payment-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .payment-option:hover,
        .payment-option.active {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.05);
        }

        .payment-option input {
            accent-color: var(--gold);
        }

        .btn-checkout {
            width: 100%;
            margin-top: 2rem;
            padding: 1.2rem;
            font-size: 1rem;
        }

        /* Mobile */
        @media (max-width: 900px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }

            .order-summary {
                position: static;
                order: -1;
                /* Resumen primero en movil */
                margin-bottom: 3rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- Header Simplificado -->
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                CABRA & <span>CURADO</span>
            </a>
            <a href="index.html" class="nav-link">‚Üê Volver al Cat√°logo</a>
        </div>
    </header>

    <div class="checkout-container">
        <!-- Columna Izquierda: Datos -->
        <div class="checkout-form">
            <h2 class="checkout-title">Datos de Env√≠o</h2>

            <form id="checkoutForm">
                <div class="checkout-section">
                    <h3 style="color:white; margin-bottom:1.5rem; font-size:1.2rem;">Contacto</h3>
                    <div class="form-grid">
                        <div class="form-group form-full">
                            <label>Correo Electr√≥nico</label>
                            <input type="email" id="email" class="form-control" required placeholder="tu@email.com">
                        </div>
                        <div class="form-group form-full"> <!-- A√±adido Tel√©fono -->
                            <label>Tel√©fono (WhatsApp)</label>
                            <input type="tel" id="phone" class="form-control" required placeholder="+569 1234 5678">
                        </div>
                    </div>
                </div>

                <div class="checkout-section">
                    <h3 style="color:white; margin-bottom:1.5rem; font-size:1.2rem;">Direcci√≥n de Entrega</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" id="firstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Apellido</label>
                            <input type="text" id="lastName" class="form-control" required>
                        </div>
                        <div class="form-group form-full">
                            <label>Direcci√≥n (Calle y N√∫mero)</label>
                            <input type="text" id="address" class="form-control" required>
                        </div>
                        <div class="form-group form-full">
                            <label>Departamento / Casa (Opcional)</label>
                            <input type="text" id="apartment" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Comuna</label>
                            <select id="comuna" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Las Condes">Las Condes</option>
                                <option value="Vitacura">Vitacura</option>
                                <option value="Lo Barnechea">Lo Barnechea</option>
                                <option value="Providencia">Providencia</option>
                                <option value="√ëu√±oa">√ëu√±oa</option>
                                <option value="Santiago">Santiago Centro</option>
                                <option value="Otro">Otra (Regi√≥n Metropolitana)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Regi√≥n</label>
                            <input type="text" value="Metropolitana" class="form-control" disabled
                                style="opacity: 0.5;">
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Columna Derecha: Resumen y Pago -->
        <div class="order-summary-wrapper">
            <div class="order-summary">
                <h3 style="color:var(--gold); margin-bottom:1.5rem;">Resumen del Pedido</h3>

                <div id="checkoutItems" class="checkout-items">
                    <!-- Items cargados via JS -->
                </div>

                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="summarySubtotal">$0</span>
                </div>
                <div class="summary-row">
                    <span>Env√≠o</span>
                    <span id="summaryShipping">Calculando...</span>
                </div>

                <div class="summary-row summary-total">
                    <span>Total</span>
                    <span id="summaryTotal">$0</span>
                </div>

                <div class="payment-methods">
                    <h4 style="color:white; margin-bottom:1rem; font-size:1rem;">M√©todo de Pago</h4>

                    <label class="payment-option active" onclick="selectPayment('whatsapp')">
                        <input type="radio" name="payment" value="whatsapp" checked>
                        <div>
                            <strong>Coordinar por WhatsApp</strong>
                            <p style="font-size:0.8rem; color:var(--text-muted); margin:0;">Confirmar stock y recibir
                                datos de transferencia.</p>
                        </div>
                    </label>

                    <label class="payment-option" onclick="selectPayment('mercadopago')">
                        <input type="radio" name="payment" value="mercadopago">
                        <div>
                            <strong>Mercado Pago</strong>
                            <p style="font-size:0.8rem; color:var(--text-muted); margin:0;">Tarjetas de Cr√©dito, D√©bito.
                            </p>
                        </div>
                    </label>
                </div>

                <button class="btn btn-primary btn-checkout" id="placeOrderBtn">Confirmar Pedido</button>

                <p style="font-size:0.8rem; color:var(--text-muted); text-align:center; margin-top:1rem;">
                    <i class="fas fa-lock"></i> Compra segura y encriptada.
                </p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="data-manager.js"></script>
    <script>
        // L√≥gica de Checkout
        let cart = [];
        let shippingCost = 0;

        document.addEventListener('DOMContentLoaded', () => {
            loadCart();
            renderOrderSummary();

            // Event listener para cambio de comuna (calculo de env√≠o)
            document.getElementById('comuna').addEventListener('change', calculateShipping);

            // Event listener para bot√≥n comprar
            document.getElementById('placeOrderBtn').addEventListener('click', handleCheckout);
        });

        function loadCart() {
            const savedCart = localStorage.getItem('cabra_curado_cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }

            if (cart.length === 0) {
                alert('El carrito est√° vac√≠o');
                window.location.href = 'index.html';
            }
        }

        function calculateShipping(e) {
            const subtotal = cart.reduce((sum, item) => sum + (item.precio * item.quantity), 0);
            const comuna = e ? e.target.value : document.getElementById('comuna').value;

            // L√≥gica de env√≠o
            if (subtotal >= 50000) {
                shippingCost = 0;
            } else {
                if (comuna === 'Otro') {
                    shippingCost = 7000;
                } else if (comuna) {
                    shippingCost = 5000;
                } else {
                    shippingCost = 0; // A√∫n no seleccionado
                }
            }

            renderOrderSummary();
        }

        function renderOrderSummary() {
            const itemsContainer = document.getElementById('checkoutItems');
            const subtotalEl = document.getElementById('summarySubtotal');
            const shippingEl = document.getElementById('summaryShipping');
            const totalEl = document.getElementById('summaryTotal');

            // Render Items
            itemsContainer.innerHTML = cart.map(item => {
                const icon = item.categoria === 'queso' ? 'üßÄ' : 'ü•ì';
                return `
                    <div class="checkout-item">
                        <div class="item-image">${icon}</div>
                        <div class="item-details">
                            <h4>${item.nombre}</h4>
                            <p>${item.quantity} x $${item.precio.toLocaleString('es-CL')}</p>
                        </div>
                        <div style="margin-left:auto; font-weight:600; color:var(--gold);">
                            $${(item.precio * item.quantity).toLocaleString('es-CL')}
                        </div>
                    </div>
                `;
            }).join('');

            // Totales
            const subtotal = cart.reduce((sum, item) => sum + (item.precio * item.quantity), 0);
            const total = subtotal + shippingCost;

            subtotalEl.textContent = `$${subtotal.toLocaleString('es-CL')}`;

            if (document.getElementById('comuna').value === "") {
                shippingEl.textContent = "Por calcular";
            } else {
                shippingEl.textContent = shippingCost === 0 ? "Gratis" : `$${shippingCost.toLocaleString('es-CL')}`;
            }

            totalEl.textContent = `$${total.toLocaleString('es-CL')}`;
        }

        function selectPayment(method) {
            // Visual selection logic is handled by radio buttons naturally, 
            // but we can add extra styles here if needed.
            document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
            document.querySelector(`input[value="${method}"]`).parentElement.classList.add('active');
        }

        async function handleCheckout() {
            // Validar formulario
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) {
                alert('Por favor completa todos los campos de env√≠o requeridos.');
                return;
            }

            const placeOrderBtn = document.getElementById('placeOrderBtn');
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = 'Procesando...';

            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const customer = {
                nombre: document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('phone').value,
                direccion: document.getElementById('address').value,
                comuna: document.getElementById('comuna').value,
                total: cart.reduce((sum, item) => sum + (item.precio * item.quantity), 0) + shippingCost
            };

            try {
                // 1. Guardar el pedido en Supabase/Local
                const order = await DataManager.createPedido(customer, cart);

                if (paymentMethod === 'whatsapp') {
                    // Generar mensaje de WhatsApp
                    let message = `Hola *CABRA & CURADO*, quiero confirmar mi pedido #${order.id || ''}:\n\n`;
                    cart.forEach(item => {
                        message += `‚ñ™Ô∏è ${item.quantity} x ${item.nombre} ($${(item.precio * item.quantity).toLocaleString('es-CL')})\n`;
                    });

                    message += `\n*Subtotal:* $${(customer.total - shippingCost).toLocaleString('es-CL')}`;
                    message += `\n*Env√≠o:* $${shippingCost.toLocaleString('es-CL')}`;
                    message += `\n*TOTAL A PAGAR:* $${customer.total.toLocaleString('es-CL')}`;

                    message += `\n\n*Mis Datos:*`;
                    message += `\nüë§ ${customer.nombre}`;
                    message += `\nüìç ${customer.direccion}, ${customer.comuna}`;
                    message += `\nüìß ${customer.email}`;

                    message += `\n\nQuedo atento a los datos de transferencia. ¬°Gracias!`;

                    const whatsappUrl = `https://wa.me/56912345678?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');

                    alert('¬°Pedido registrado! Te hemos redirigido a WhatsApp para coordinar el pago.');
                    localStorage.removeItem('cabra_curado_cart');
                    window.location.href = 'index.html';

                } else if (paymentMethod === 'mercadopago') {
                    // Aqu√≠ inicia la integraci√≥n de MP
                    alert('üöß Conectando con Mercado Pago...\nPedido #' + (order.id || 'N/A'));

                    // Simulaci√≥n de redirecci√≥n exitosa
                    setTimeout(() => {
                        alert('¬°Pago procesado exitosamente! Tu pedido ya est√° en camino.');
                        localStorage.removeItem('cabra_curado_cart');
                        window.location.href = 'index.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error al procesar el pedido:', error);
                alert('Hubo un error al guardar tu pedido. Por favor intenta nuevamente.');
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = 'Confirmar Pedido';
            }
        }
    </script>
</body>

</html>